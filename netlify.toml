[build]
  publish = ".next"
  command = "npm install && npm run build"

[build.environment]
  NODE_VERSION = "18"

# Redirect rules for SEO and user experience
[[redirects]]
  from = "/courses"
  to = "/courses.html"
  status = 301

[[redirects]]
  from = "/testimonials"
  to = "/success-stories.html"
  status = 301

[[redirects]]
  from = "/pricing"
  to = "/pricing.html"
  status = 301

[[redirects]]
  from = "/faq"
  to = "/faq.html"
  status = 301

[[redirects]]
  from = "/contact"
  to = "/contact.html"
  status = 301

[[redirects]]
  from = "/help"
  to = "/help-center.html"
  status = 301

# Gate all tutorial pages through a serverless function that enforces auth + purchases
[[redirects]]
  from = "/tutorial*"
  to = "/.netlify/functions/tutorialGate?path=:splat"
  status = 200

# Security headers
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=()"
    Strict-Transport-Security = "max-age=63072000; includeSubDomains; preload"
    Content-Security-Policy = "default-src 'self' https:; script-src 'self' https: 'unsafe-inline' 'unsafe-eval' https://identity.netlify.com https://www.paypal.com https://www.googletagmanager.com https://www.google-analytics.com https://tdxpostwbmpnsikjftvy.supabase.co; style-src 'self' https: 'unsafe-inline'; img-src 'self' https: data:; font-src 'self' https: data:; connect-src 'self' https://identity.netlify.com https://www.paypal.com https://tdxpostwbmpnsikjftvy.supabase.co https://premiumwebcreators.com https://www.google-analytics.com https://www.googletagmanager.com; frame-src 'self' https://www.paypal.com"

# Cache static assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.png"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.jpg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.jpeg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.gif"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.svg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.ico"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# HTML files - shorter cache for updates
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=3600"

# Netlify Functions
[functions]
  directory = "netlify/functions"

# Form handling
[forms]
  [forms.contact]
    name = "Contact Form"
    action = "/thank-you"
    method = "POST"
    [forms.contact.fields.name]
      required = true
    [forms.contact.fields.email]
      required = true
    [forms.contact.fields.message]
      required = true

# Environment variables (set in Netlify dashboard)
# SUPABASE_URL = "your-supabase-url"
# SUPABASE_ANON_KEY = "your-anon-key"
# SUPABASE_SERVICE_ROLE_KEY = "your-service-role-key"
# WEBHOOK_SECRET = "your-webhook-secret"

# Edge functions for better performance
[[edge_functions]]
  function = "supabaseHandler"
  path = "/.netlify/functions/supabaseHandler"

# Sitemap generation
[[plugins]]
  package = "@netlify/plugin-sitemap"
  [plugins.inputs]
    buildDir = "."
    exclude = ["/admin/*", "/private/*"]

# Image optimization
[[plugins]]
  package = "@netlify/plugin-lighthouse"
  [plugins.inputs]
    output_path = "lighthouse-report.html"

# Performance optimizations
[[plugins]]
  package = "netlify-plugin-minify-html"
  [plugins.inputs.minifierOptions]
    collapseWhitespace = true
    conservativeCollapse = true
    removeComments = true
    removeEmptyAttributes = true
    removeRedundantAttributes = true
    preserveLineBreaks = false
    removeAttributeQuotes = false
    removeEmptyElements = false
    removeOptionalTags = false
    removeScriptTypeAttributes = true
    removeStyleLinkTypeAttributes = true
    sortAttributes = true
    sortClassName = true
    useShortDoctype = true
    minifyCSS = true
    minifyJS = true

[[plugins]]
  package = "@netlify/plugin-nextjs"